name: Deploy_Contract_Application

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string

env:
  PROJECT_ID: ${{ secrets.DATA_MANAGEMENT_PROJECT_ID }}
  REGION: europe-west4
  ARTIFACT_REGISTRY: europe-west4-docker.pkg.dev/${{ secrets.DATA_MANAGEMENT_PROJECT_ID }}/data-management/contract-app
  DOMAIN: ${{ secrets.MY_DOMAIN }}
  SPRING_CLOUD_GCP_DATASTORE_PROJECT_ID: ${{ secrets.DATA_MANAGEMENT_PROJECT_ID }}
  SPRING_CLOUD_GCP_DATASTORE_DATABASE_ID: ${{ secrets.DATASTORE_DATABASE_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.DEPLOYMENT_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL_NAME }}/providers/${{ secrets.WIF_PROVIDER_NAME }}'
          service_account: ${{ secrets.DEPLOYMENT_SVC }}
          audience: ${{ secrets.WIF_AUDIENCE }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set image tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          fi
          echo "Deploying with image tag: $IMAGE_TAG"

      - name: Verify images exist
        run: |
          echo "Checking if images exist..."
          gcloud container images describe ${{ env.ARTIFACT_REGISTRY }}/contract-application:${{ env.IMAGE_TAG }} || exit 1
          gcloud container images describe ${{ env.ARTIFACT_REGISTRY }}/contract-ui:${{ env.IMAGE_TAG }} || exit 1
          echo "âœ… Images verified"

      - name: Update Cloud Run service YAML with image tags
        run: |
          # Create a copy of the YAML file with the correct image tags
          cp contract-app-cloud-run.yml contract-app-cloud-run-deploy.yml
          
          # Update image tags
          sed -i "s|contract-application:latest|contract-application:${{ env.IMAGE_TAG }}|g" contract-app-cloud-run-deploy.yml
          sed -i "s|contract-ui:latest|contract-ui:${{ env.IMAGE_TAG }}|g" contract-app-cloud-run-deploy.yml

          # Substitute environment variables and create deployment file
          envsubst < contract-app-cloud-run.yml > contract-app-cloud-run-deploy.yml
          
          echo "Updated YAML file:"
          cat contract-app-cloud-run-deploy.yml

      - name: Deploy to Cloud Run with
        run: |
          echo "Deploying contract-app..."
          gcloud run services replace contract-app-cloud-run-deploy.yml --region=${{ env.REGION }}

      - name: Configure Cloud Run for IAP
        run: |
          echo "Enabling IAP for contract-app..."
          gcloud beta run services update contract-app \
          --region=${{ env.REGION }} \
          --iap

          echo "Getting project number..."
          PROJECT_NUMBER=$(gcloud projects describe ${{ env.PROJECT_ID }} --format="value(projectNumber)")

          echo "Grant invoker permission to the IAP service agent..."
          gcloud beta run services add-iam-policy-binding contract-app \
            --region=${{ env.REGION }} \
            --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-iap.iam.gserviceaccount.com" \
            --role="roles/run.invoker"

      - name: Get service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe contract-app --region=${{ env.REGION }} --format="value(status.url)")
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ðŸš€ Service deployed at: $SERVICE_URL"

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ·ï¸ **Image Tag:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Backend Image:** \`${{ env.ARTIFACT_REGISTRY }}/contract-application:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Frontend Image:** \`${{ env.ARTIFACT_REGISTRY }}/contract-ui:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Service URL:** ${{ steps.get-url.outputs.SERVICE_URL }}" >> $GITHUB_STEP_SUMMARY

  post-deploy:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Notify deployment success
        run: |
          echo "ðŸŽ‰ Contract Application successfully deployed!"
          echo "Service URL: ${{ needs.deploy.outputs.SERVICE_URL }}"