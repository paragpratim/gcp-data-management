name: Build_Deploy_Contract_Application

on:
  push:
    branches: [ main ]
    paths:
      - 'contract-application/**'
      - 'contract-ui/**'
      - 'contract-app-cloud-run.yml'
      - '.github/workflows/deploy-contract-app.yml'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag (leave empty for git SHA)'
        required: false
        type: string

env:
  PROJECT_ID: ${{ secrets.DATA_MANAGEMENT_PROJECT_ID }}
  REGION: europe-west4
  ARTIFACT_REGISTRY: europe-west4-docker.pkg.dev/${{ secrets.DATA_MANAGEMENT_PROJECT_ID }}/data-management/contract-app
  SPRING_CLOUD_GCP_DATASTORE_PROJECT_ID: ${{ secrets.DATA_MANAGEMENT_PROJECT_ID }}
  SPRING_CLOUD_GCP_DATASTORE_DATABASE_ID: ${{ secrets.DATASTORE_DATABASE_ID }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          if [ "${{ github.event.inputs.image_tag }}" != "" ]; then
            echo "IMAGE_TAG=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
            echo "Using custom image tag: ${{ github.event.inputs.image_tag }}"
          else
            echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "Using git SHA as image tag: ${{ github.sha }}"
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.DEPLOYMENT_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL_NAME }}/providers/${{ secrets.WIF_PROVIDER_NAME }}'
          service_account: ${{ secrets.DEPLOYMENT_SVC }}
          audience: ${{ secrets.WIF_AUDIENCE }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install gcloud beta components
        run: |
          gcloud components install beta --quiet

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: contract-ui/package-lock.json

      - name: Install BigQuery JDBC Driver
        run: |
          cd contract-application/services/local-repo
          mvn install:install-file \
            -Dfile=GoogleBigQueryJDBC42-1.5.4.1008.jar \
            -DgroupId=com.simba.googlebigquery.jdbc \
            -DartifactId=GoogleBigQueryJDBC42 \
            -Dversion=1.5.4 \
            -Dpackaging=jar \
            -DgeneratePom=true

      - name: Build Java backend
        env:
          SPRING_PROFILES_ACTIVE: prod
        run: |
          cd contract-application
          ./mvnw clean install -Dspring.profiles.active=prod

      - name: Build React frontend
        run: |
          cd contract-ui
          npm ci
          npm run build

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push backend image
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
        run: |
          docker build -t ${{ env.ARTIFACT_REGISTRY }}/contract-application:${{ env.IMAGE_TAG }} \
                       -t ${{ env.ARTIFACT_REGISTRY }}/contract-application:latest \
                       ./contract-application
          docker push ${{ env.ARTIFACT_REGISTRY }}/contract-application:${{ env.IMAGE_TAG }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/contract-application:latest

      - name: Build and push frontend image
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
        run: |
          docker build -t ${{ env.ARTIFACT_REGISTRY }}/contract-ui:${{ env.IMAGE_TAG }} \
                       -t ${{ env.ARTIFACT_REGISTRY }}/contract-ui:latest \
                       ./contract-ui
          docker push ${{ env.ARTIFACT_REGISTRY }}/contract-ui:${{ env.IMAGE_TAG }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/contract-ui:latest

      - name: Update Cloud Run service YAML with environment variables and image tags
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
        run: |
          # Create a copy of the YAML file
          cp contract-app-cloud-run.yml contract-app-cloud-run-deploy.yml

          # Update image tags
          sed -i "s|contract-application:latest|contract-application:${{ env.IMAGE_TAG }}|g" contract-app-cloud-run-deploy.yml
          sed -i "s|contract-ui:latest|contract-ui:${{ env.IMAGE_TAG }}|g" contract-app-cloud-run-deploy.yml
          
          # Substitute environment variables
          envsubst < contract-app-cloud-run-deploy.yml > contract-app-cloud-run-final.yml
          mv contract-app-cloud-run-final.yml contract-app-cloud-run-deploy.yml
          
          echo "Updated YAML file:"
          cat contract-app-cloud-run-deploy.yml

      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace contract-app-cloud-run-deploy.yml --region=${{ env.REGION }}

      - name: Configure Cloud Run for IAP
        run: |
          echo "Enabling IAP for contract-app..."
          gcloud beta run services update contract-app \
          --region=${{ env.REGION }} \
          --iap

          echo "Getting project number..."
          PROJECT_NUMBER=$(gcloud projects describe ${{ env.PROJECT_ID }} --format="value(projectNumber)")

          echo "Grant invoker permission to the IAP service agent..."
          gcloud run services add-iam-policy-binding contract-app \
            --region=${{ env.REGION }} \
            --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-iap.iam.gserviceaccount.com" \
            --role="roles/run.invoker"

      - name: Get service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe contract-app --region=${{ env.REGION }} --format="value(status.url)")
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "üöÄ Service deployed at: $SERVICE_URL"

      - name: Output deployment info
        env:
          IMAGE_TAG: ${{ steps.set-tag.outputs.IMAGE_TAG }}
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Branch/Ref:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Image Tag:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Backend Image:** \`${{ env.ARTIFACT_REGISTRY }}/contract-application:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Frontend Image:** \`${{ env.ARTIFACT_REGISTRY }}/contract-ui:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üåê Application URLs" >> $GITHUB_STEP_SUMMARY
          echo "üè† **Frontend Application:** [${{ steps.get-url.outputs.SERVICE_URL }}](${{ steps.get-url.outputs.SERVICE_URL }})" >> $GITHUB_STEP_SUMMARY
          echo "üìö **API Documentation (Swagger UI):** [${{ steps.get-url.outputs.SERVICE_URL }}/swagger-ui/index.html](${{ steps.get-url.outputs.SERVICE_URL }}/swagger-ui/index.html)" >> $GITHUB_STEP_SUMMARY
          echo "üìñ **API Docs (OpenAPI JSON):** [${{ steps.get-url.outputs.SERVICE_URL }}/v3/api-docs](${{ steps.get-url.outputs.SERVICE_URL }}/v3/api-docs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** These URLs are protected by Google Cloud IAP and require authentication." >> $GITHUB_STEP_SUMMARY

    outputs:
      service_url: ${{ steps.get-url.outputs.SERVICE_URL }}
      image_tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}

  post-deploy:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: always() && needs.build-and-deploy.result == 'success'
    
    steps:
      - name: Notify deployment success
        run: |
          echo "üéâ Contract Application successfully deployed!"
          echo ""
          echo "üìã **Deployment Details:**"
          echo "   - Trigger: ${{ github.event_name }}"
          echo "   - Image Tag: ${{ needs.build-and-deploy.outputs.image_tag }}"
          echo ""
          echo "üåê **Application URLs:**"
          echo "   - Frontend: ${{ needs.build-and-deploy.outputs.service_url }}"
          echo "   - Swagger UI: ${{ needs.build-and-deploy.outputs.service_url }}/swagger-ui/index.html"
          echo "   - API Docs: ${{ needs.build-and-deploy.outputs.service_url }}/v3/api-docs"
          echo ""
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "‚úÖ Automatic deployment triggered by push to main branch"
          else
            echo "‚úÖ Manual deployment triggered via workflow_dispatch"
          fi
          echo ""
          echo "üîê Note: All URLs require IAP authentication"