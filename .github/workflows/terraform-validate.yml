name: Terraform_Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'terraform/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
  workflow_dispatch:

jobs:
  terraform-validate:
    runs-on: ubuntu-latest
    name: Validate Terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'

      - name: Set up TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.48.0

      - name: Check Terraform format
        run: |
          echo "ðŸŽ¨ Checking Terraform format..."
          
          # Find all Terraform files in terraform directory
          terraform_files=$(find terraform -name "*.tf" -type f 2>/dev/null || echo "")
          
          if [ -z "$terraform_files" ]; then
            echo "âš ï¸ No Terraform files found in terraform directory"
            exit 0
          fi
          
          echo "Found Terraform files:"
          echo "$terraform_files"
          echo ""
          
          # Check format
          format_failed=false
          for file in $terraform_files; do
            echo "Checking format: $file"
            if ! terraform fmt -check -diff "$file"; then
              echo "âŒ Format check failed for: $file"
              format_failed=true
            fi
          done
          
          if [ "$format_failed" = true ]; then
            echo ""
            echo "âŒ Terraform format validation failed!"
            echo "ðŸ’¡ To fix, run: terraform fmt -recursive terraform/"
            exit 1
          else
            echo ""
            echo "âœ… All Terraform files are properly formatted!"
          fi

      - name: Validate Terraform syntax
        run: |
          echo "ðŸ” Validating Terraform syntax..."
          
          # Find all directories containing .tf files in terraform directory
          terraform_dirs=$(find terraform -name "*.tf" -type f 2>/dev/null | xargs dirname | sort | uniq || echo "")
          
          if [ -z "$terraform_dirs" ]; then
            echo "âš ï¸ No Terraform directories found"
            exit 0
          fi
          
          validation_failed=false
          
          for dir in $terraform_dirs; do
            echo ""
            echo "ðŸ“ Validating directory: $dir"
            cd "$dir"
            
            # Initialize without backend (syntax check only)
            echo "  ðŸ”§ Initializing (syntax check only)..."
            if ! terraform init -backend=false -input=false > /dev/null 2>&1; then
              echo "  âŒ Terraform init failed"
              validation_failed=true
            else
              echo "  âœ… Init successful"
              
              # Validate syntax
              echo "  ðŸ” Validating syntax..."
              if ! terraform validate; then
                echo "  âŒ Syntax validation failed"
                validation_failed=true
              else
                echo "  âœ… Syntax is valid"
              fi
            fi
            
            cd - > /dev/null
          done
          
          if [ "$validation_failed" = true ]; then
            echo ""
            echo "âŒ Terraform syntax validation failed!"
            exit 1
          else
            echo ""
            echo "ðŸŽ‰ All Terraform configurations have valid syntax!"
          fi

      - name: Run TFLint
        run: |
          echo "ðŸ” Running Terraform linting checks..."
          
          # Check if terraform directory exists
          if [ ! -d "terraform" ]; then
            echo "âš ï¸ No terraform directory found"
            exit 0
          fi
          
          # Find all Terraform directories
          terraform_dirs=$(find terraform -name "*.tf" -type f 2>/dev/null | xargs dirname | sort | uniq || echo "")
          
          if [ -z "$terraform_dirs" ]; then
            echo "âš ï¸ No Terraform directories found for linting"
            exit 0
          fi
          
          lint_failed=false
          
          for dir in $terraform_dirs; do
            echo ""
            echo "ðŸ“ Linting directory: $dir"
            
            # Check if there's a .tflint.hcl in this directory
            if [ -f "$dir/.tflint.hcl" ]; then
              echo "  Found .tflint.hcl, trying to initialize plugins..."
              cd "$dir"
              
              # Try to initialize with plugins, but continue if it fails
              if ! tflint --init > /dev/null 2>&1; then
                echo "  âš ï¸ Plugin initialization failed, running with basic rules only"
                if ! tflint --format=compact \
                    --disable-rule=terraform_required_providers \
                    --disable-rule=terraform_required_version \
                    --config="" 2>/dev/null; then
                  echo "  âŒ TFLint found issues"
                  lint_failed=true
                else
                  echo "  âœ… No linting issues found (basic rules)"
                fi
              else
                echo "  âœ… Plugins initialized successfully"
                if ! tflint --format=compact \
                    --disable-rule=terraform_required_providers \
                    --disable-rule=terraform_required_version; then
                  echo "  âŒ TFLint found issues"
                  lint_failed=true
                else
                  echo "  âœ… No linting issues found"
                fi
              fi
              cd - > /dev/null
            else
              echo "  No .tflint.hcl found, using default rules"
              if ! tflint --chdir="$dir" --format=compact \
                  --disable-rule=terraform_required_providers \
                  --disable-rule=terraform_required_version; then
                echo "  âŒ TFLint found issues"
                lint_failed=true
              else
                echo "  âœ… No linting issues found"
              fi
            fi
          done
          
          if [ "$lint_failed" = true ]; then
            echo ""
            echo "âŒ Terraform linting failed!"
            echo "ðŸ’¡ Fix the issues above and run 'tflint' locally to verify"
            exit 1
          else
            echo ""
            echo "ðŸŽ‰ All Terraform configurations passed linting checks!"
          fi

      - name: Terraform validation summary
        run: |
          echo "## Terraform Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Format Check:** All Terraform files properly formatted" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Syntax Check:** All Terraform configurations valid" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Linting Check:** All configurations follow best practices" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Branch/Ref:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validation Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¨ Format checking with \`terraform fmt\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Syntax validation with \`terraform validate\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ Best practices linting with \`tflint\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Validation runs without cloud provider authentication" >> $GITHUB_STEP_SUMMARY