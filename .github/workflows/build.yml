name: Build

on:
  push:
    branches: [ main ]
    paths:
      - 'contract-application/**'
      - 'contract-ui/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'contract-application/**'
      - 'contract-ui/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: contract-ui/package-lock.json

      - name: Install BigQuery JDBC Driver
        run: |
          cd contract-application/services/local-repo
          mvn install:install-file \
            -Dfile=GoogleBigQueryJDBC42-1.5.4.1008.jar \
            -DgroupId=com.simba.googlebigquery.jdbc \
            -DartifactId=GoogleBigQueryJDBC42 \
            -Dversion=1.5.4 \
            -Dpackaging=jar \
            -DgeneratePom=true

      - name: Build Java backend
        run: |
          cd contract-application
          ./mvnw clean install

      - name: Build React frontend
        run: |
          cd contract-ui
          npm ci
          npm run build

      - name: Upload All Test Results
        uses: actions/upload-artifact@v4
        with:
          name: all-surefire-reports
          path: '**/target/surefire-reports/'

      - name: Merge Jacoco Coverage
        run: |
          cd contract-application
          zsh jacoco-merge-report.sh

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-coverage-report
          path: contract-application/jacoco-merged-report/html/

      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Java Backend:** Built successfully" >> $GITHUB_STEP_SUMMARY
          echo "✅ **React Frontend:** Built successfully" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Branch/Ref:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY